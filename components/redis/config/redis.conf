# ==============================================================================
# Redis Configuration (Base)
# ==============================================================================

# ------------------------------------------------------------------------------
# Networking
# ------------------------------------------------------------------------------

# Disable protected mode for in-cluster access.
# Network policies and Service abstractions manage access control.
protected-mode no

# TCP port.
port 6379

# TCP listen backlog. Increase for high connection rates.
tcp-backlog 511

# Close idle client connections after N seconds (0 = disabled).
timeout 0

# TCP keepalive interval (seconds). Helps detect dead peers.
tcp-keepalive 300

# Run in foreground (container mode).
daemonize no

# Systemd/upstart supervision. Not used in containers.
supervised no

# Logging verbosity: debug, verbose, notice, warning.
loglevel notice

# ------------------------------------------------------------------------------
# Data / Persistence
# ------------------------------------------------------------------------------

# Number of logical databases.
databases 16

# Snapshotting (RDB) rules: save <seconds> <changes>.
# Save if <changes> keys changed in <seconds>.
save 900 1
save 300 10
save 60 10000

# Stop accepting writes if background save fails (prevents data divergence).
stop-writes-on-bgsave-error yes

# Enable RDB compression and checksums.
rdbcompression yes
rdbchecksum yes

# RDB filename and directory.
dbfilename dump.rdb
dir /data

# Replicas are read-only.
replica-read-only yes

# Replication settings.
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no

# Replica priority. Lower values reduce promotion chance.
replica-priority 100

# ------------------------------------------------------------------------------
# Memory Management
# ------------------------------------------------------------------------------

# Max memory limit. Should be lower than container memory limit.
maxmemory 256mb

# Eviction policy: evict least-recently-used keys when maxmemory is reached.
maxmemory-policy allkeys-lru

# ------------------------------------------------------------------------------
# Append Only File (AOF)
# ------------------------------------------------------------------------------

# Enable AOF for better durability than RDB alone.
appendonly yes
appendfilename "appendonly.aof"

# Fsync policy: everysec balances durability and performance.
appendfsync everysec

# Do not stop fsync during rewrites (safer).
no-appendfsync-on-rewrite no

# Automatic AOF rewrite triggers.
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ------------------------------------------------------------------------------
# Includes (Hooks)
# ------------------------------------------------------------------------------

# ACL configuration (generated by init container).
include /etc/redis/redis-auth.conf

# Custom configuration for environment-specific overrides.
include /etc/redis/redis-custom.conf

# Replication configuration (generated by init container).
include /etc/redis/redis-replication.conf
